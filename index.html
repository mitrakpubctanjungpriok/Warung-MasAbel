<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#1d4ed8" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <!-- Logo / Icon (letakkan file "mas-abel.png" di folder yang sama dengan index.html) -->
    <link rel="icon" type="image/png" href="mas-abel.png" />
    <link rel="apple-touch-icon" href="mas-abel.png" />
    <!-- Fallback icon (SVG) jika PNG belum ada -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='28' fill='%231d4ed8'/><path d='M40 46h48c5 0 9 4 9 9v42c0 5-4 9-9 9H40c-5 0-9-4-9-9V55c0-5 4-9 9-9Z' fill='white' opacity='0.95'/><path d='M46 58h36v8H46v-8Zm0 16h36v8H46v-8Zm0 16h22v8H46v-8Z' fill='%231d4ed8'/></svg>" />

    <link id="manifest-link" rel="manifest" href="" />

    <title>Warung Mas Abel (Mobile) - Hutang & Pelunasan</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .card-shadow { box-shadow: 0 8px 24px rgba(0,0,0,0.10); }
        .modal { display: none; }
        .modal.active { display: flex; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Mobile-only: blokir tampilan desktop */
        #desktop-blocker { display:none; }
        @media (min-width: 768px) {
            #app { display:none !important; }
            #desktop-blocker { display:flex !important; }
        }

        /* Safe area */
        .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 6rem); }
        .bottom-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Toast animation helpers */
        .toast-hidden { transform: translateY(16px); opacity: 0; pointer-events: none; }
        .toast-shown { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Desktop Blocker -->
    <div id="desktop-blocker" class="fixed inset-0 bg-gradient-to-br from-slate-900 to-slate-800 text-white items-center justify-center p-10">
        <div class="max-w-lg w-full">
            <div class="bg-white/10 border border-white/20 rounded-2xl p-6">
                <div class="flex items-center gap-3">
                    <div class="bg-white/15 p-2 rounded-xl">
                        <img src="mas-abel.png" alt="Logo Warung Mas Abel" class="w-10 h-10 object-cover rounded-lg" onerror="this.style.display='none'" />
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Warung Mas Abel</h1>
                        <p class="text-sm text-white/75">Aplikasi ini khusus tampilan handphone.</p>
                    </div>
                </div>
                <div class="mt-5 text-white/80 text-sm space-y-2">
                    <p>Silakan buka lewat perangkat mobile (lebar layar &lt; 768px).</p>
                    <p>Tips: gunakan mode device toolbar di browser (Responsive/Phone) jika ingin uji di komputer.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- App (Mobile) -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-40 bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-1.5 rounded-xl">
                        <img src="mas-abel.png" alt="Logo Warung Mas Abel" class="w-10 h-10 object-cover rounded-lg" onerror="this.style.display='none'" />
                    </div>
                    <div>
                        <h1 class="text-base font-bold leading-tight">Warung Mas Abel</h1>
                        <p class="text-[11px] text-blue-200 leading-tight">Hutang & Pelunasan</p>
                    </div>
                </div>
                <button id="btn-install" onclick="triggerInstall()" class="hidden bg-white/20 active:bg-white/30 p-2 rounded-xl transition" aria-label="Install Aplikasi">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v10m0 0l3-3m-3 3l-3-3M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Content -->
        <main class="flex-1 max-w-md mx-auto w-full px-4 pt-4 pb-safe">
            <!-- Dashboard Tab -->
            <section id="content-dashboard" class="tab-content">
                <div class="grid grid-cols-1 gap-3 mb-4">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-2xl card-shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-green-100 text-xs">Pelunasan Hari Ini</p>
                                <p class="text-2xl font-bold mt-2" id="total-hari-ini">Rp 0</p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-xl">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-5 rounded-2xl card-shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-red-100 text-xs">Total Hutang</p>
                                <p class="text-2xl font-bold mt-2" id="total-hutang">Rp 0</p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-xl">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-6v11c0 1.1-.9 2-2 2H4v-2h17V7h2z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-2xl card-shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-blue-100 text-xs">Aktivitas Hari Ini</p>
                                <p class="text-2xl font-bold mt-2" id="jumlah-transaksi">0</p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-xl">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-4 card-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-base">Aktivitas Terakhir</h3>
                        <button onclick="switchTab('kasir')" class="text-blue-600 text-sm font-semibold">Tambah Hutang</button>
                    </div>
                    <div id="transaksi-terakhir" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Belum ada transaksi</p>
                    </div>
                </div>
            </section>

            <!-- Kasir Tab -->
            <section id="content-kasir" class="tab-content hidden">
                <div class="bg-white rounded-2xl p-4 card-shadow mb-4">
                    <div class="flex items-center justify-between gap-3 mb-3">
                        <h3 class="font-bold text-base">Pilih Produk</h3>
                        <input type="text" id="search-produk" placeholder="Cari..." class="border rounded-xl px-3 py-2 text-sm w-40" onkeyup="filterProduk()" />
                    </div>
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-[11px] text-gray-500">Kategori dipisah: <b>Minuman</b> & <b>Rokok</b></p>
                        <button type="button" onclick="resetFilterProduk()" class="border rounded-xl px-3 py-2 text-sm font-semibold text-gray-700 active:bg-gray-50">Reset</button>
                    </div>
                    <div id="produk-grid" class="space-y-4 max-h-[48vh] overflow-y-auto">
                        <!-- Products will be loaded here -->
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-4 card-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-base">Keranjang</h3>
                        <button onclick="kosongkanKeranjang()" class="text-sm font-semibold text-gray-600">Kosongkan</button>
                    </div>
                    <div id="keranjang" class="space-y-2 max-h-56 overflow-y-auto mb-4">
                        <p class="text-gray-500 text-center py-4 text-sm">Keranjang kosong</p>
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex justify-between font-bold text-lg mb-3">
                            <span>Total</span>
                            <span id="total-keranjang">Rp 0</span>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="prosesTransaksi()" class="w-full bg-orange-500 active:bg-orange-600 text-white py-3 rounded-xl font-semibold transition">
                                Catat Hutang
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Hutang Tab -->
            <section id="content-hutang" class="tab-content hidden">
                <div class="bg-white rounded-2xl p-4 card-shadow mb-4">
                    <div class="flex flex-col gap-3 mb-4">
                        <div class="flex items-center justify-between">
                            <h3 class="font-bold text-base">Daftar Hutang</h3>
                            <button onclick="manualSync()" class="text-sm font-semibold text-blue-600">Sync</button>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <input type="text" id="search-hutang" placeholder="Cari nama..." class="border rounded-xl px-3 py-2 text-sm" onkeyup="filterHutang()" />
                            <select id="filter-status" class="border rounded-xl px-3 py-2 text-sm" onchange="filterHutang()">
                                <option value="semua">Semua</option>
                                <option value="belum">Belum Lunas</option>
                                <option value="lunas">Lunas</option>
                            </select>
                        </div>
                    </div>
                    <div id="hutang-list" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Belum ada data hutang</p>
                    </div>
                </div>
            </section>

            <!-- Produk Tab -->
            <section id="content-produk" class="tab-content hidden">
                <div class="bg-white rounded-2xl p-4 card-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-base">Kelola Produk</h3>
                        <button onclick="openModalProduk()" class="bg-blue-500 active:bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold text-sm transition flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Tambah
                        </button>
                    </div>
                    <div id="produk-list" class="space-y-2">
                        <p class="text-gray-500 text-center py-8">Belum ada produk</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 inset-x-0 z-40 bg-white border-t border-gray-200 bottom-safe">
            <div class="max-w-md mx-auto px-2 py-2 grid grid-cols-4 gap-2">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active rounded-2xl py-2 px-2 font-semibold text-[11px] transition flex flex-col items-center justify-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                    <span>Home</span>
                </button>
                <button onclick="switchTab('kasir')" id="tab-kasir" class="rounded-2xl py-2 px-2 font-semibold text-[11px] text-gray-600 active:bg-gray-100 transition flex flex-col items-center justify-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <span>Catat</span>
                </button>
                <button onclick="switchTab('hutang')" id="tab-hutang" class="rounded-2xl py-2 px-2 font-semibold text-[11px] text-gray-600 active:bg-gray-100 transition flex flex-col items-center justify-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    <span>Hutang</span>
                </button>
                <button onclick="switchTab('produk')" id="tab-produk" class="rounded-2xl py-2 px-2 font-semibold text-[11px] text-gray-600 active:bg-gray-100 transition flex flex-col items-center justify-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                    <span>Produk</span>
                </button>
            </div>
        </nav>

        <!-- Modal Produk -->
        <div id="modal-produk" class="modal fixed inset-0 bg-black/50 items-end justify-center z-50 p-0">
            <div class="bg-white rounded-t-3xl p-5 w-full max-w-md card-shadow">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-base" id="modal-produk-title">Tambah Produk</h3>
                    <button onclick="closeModalProduk()" class="p-2 rounded-xl bg-gray-100">Tutup</button>
                </div>
                <form id="form-produk" onsubmit="simpanProduk(event)">
                    <input type="hidden" id="produk-id">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nama Produk</label>
                            <input type="text" id="produk-nama" required class="w-full border rounded-xl px-3 py-3 text-base" autocomplete="off">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Kategori</label>
                            <select id="produk-kategori" required class="w-full border rounded-xl px-3 py-3 text-base bg-white">
                                <option value="Minuman">Minuman</option>
                                <option value="Rokok">Rokok</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Harga</label>
                            <input type="number" id="produk-harga" required class="w-full border rounded-xl px-3 py-3 text-base" inputmode="numeric">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-5">
                        <button type="button" onclick="closeModalProduk()" class="flex-1 bg-gray-200 active:bg-gray-300 py-3 rounded-xl font-semibold transition">Batal</button>
                        <button type="submit" class="flex-1 bg-blue-500 active:bg-blue-600 text-white py-3 rounded-xl font-semibold transition">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Hutang -->
        <div id="modal-hutang" class="modal fixed inset-0 bg-black/50 items-end justify-center z-50 p-0">
            <div class="bg-white rounded-t-3xl p-5 w-full max-w-md card-shadow">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-base">Catat Hutang</h3>
                    <button onclick="closeModalHutang()" class="p-2 rounded-xl bg-gray-100">Tutup</button>
                </div>
                <form id="form-hutang" onsubmit="simpanHutang(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nama Pelanggan</label>
                            <input type="text" id="hutang-nama" required class="w-full border rounded-xl px-3 py-3 text-base" autocomplete="name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">No. HP (Opsional)</label>
                            <input type="text" id="hutang-hp" class="w-full border rounded-xl px-3 py-3 text-base" inputmode="tel" autocomplete="tel">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Total Hutang</label>
                            <input type="text" id="hutang-total" readonly class="w-full border rounded-xl px-3 py-3 text-base bg-gray-100">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-5">
                        <button type="button" onclick="closeModalHutang()" class="flex-1 bg-gray-200 active:bg-gray-300 py-3 rounded-xl font-semibold transition">Batal</button>
                        <button type="submit" class="flex-1 bg-orange-500 active:bg-orange-600 text-white py-3 rounded-xl font-semibold transition">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Bayar Hutang -->
        <div id="modal-bayar" class="modal fixed inset-0 bg-black/50 items-end justify-center z-50 p-0">
            <div class="bg-white rounded-t-3xl p-5 w-full max-w-md card-shadow">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-base">Bayar Hutang</h3>
                    <button onclick="closeModalBayar()" class="p-2 rounded-xl bg-gray-100">Tutup</button>
                </div>
                <form id="form-bayar" onsubmit="bayarHutang(event)">
                    <input type="hidden" id="bayar-id">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Sisa Hutang</label>
                            <input type="text" id="bayar-sisa" readonly class="w-full border rounded-xl px-3 py-3 text-base bg-gray-100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Jumlah Bayar</label>
                            <input type="number" id="bayar-jumlah" required class="w-full border rounded-xl px-3 py-3 text-base" inputmode="numeric" min="1">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-5">
                        <button type="button" onclick="closeModalBayar()" class="flex-1 bg-gray-200 active:bg-gray-300 py-3 rounded-xl font-semibold transition">Batal</button>
                        <button type="submit" class="flex-1 bg-green-500 active:bg-green-600 text-white py-3 rounded-xl font-semibold transition">Bayar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-24 bg-green-500 text-white px-5 py-3 rounded-2xl shadow-lg transition-all duration-300 z-50 toast-hidden"></div>

    </div>

    <script>
        // Data Store
        let produk = JSON.parse(localStorage.getItem('produk')) || [];
        let transaksi = JSON.parse(localStorage.getItem('transaksi')) || [];
        let hutang = JSON.parse(localStorage.getItem('hutang')) || [];
        let keranjang = [];

        function normalizeKategori(v) {
            const raw = String(v ?? '').trim().toLowerCase();
            if (raw === 'rokok') return 'Rokok';
            if (raw === 'minuman') return 'Minuman';
            return 'Minuman';
        }

        function isKategoriLike(v) {
            const raw = String(v ?? '').trim().toLowerCase();
            return raw === 'rokok' || raw === 'minuman';
        }

        function parseHarga(v) {
            // Terima angka atau string (mis: "15000", "15.000", "Rp 15.000")
            if (typeof v === 'number' && Number.isFinite(v)) return v;
            const s = String(v ?? '').trim();
            if (!s) return 0;

            // Ambil digit saja (aman untuk format Rp, pemisah ribuan ., , dll)
            const digits = s.replace(/[^0-9]/g, '');
            if (digits) return Number(digits) || 0;

            const n = Number(s);
            return Number.isFinite(n) ? n : 0;
        }

        function hashString(str) {
            // djb2
            let h = 5381;
            const s = String(str || '');
            for (let i = 0; i < s.length; i++) h = ((h << 5) + h) + s.charCodeAt(i);
            return h | 0;
        }

        function ensureProdukId(p) {
            const existing = String(p?.id ?? '').trim();
            if (existing) return existing;
            const key = `${String(p?.nama || '').trim()}|${normalizeKategori(p?.kategori)}|${Number(p?.harga) || 0}`;
            return 'gen-' + Math.abs(hashString(key)).toString(36);
        }

        function sanitizeProdukList(list) {
            const clean = (list || [])
                .map(p => ({
                    ...p,
                    nama: String(p?.nama || '').trim(),
                    kategori: normalizeKategori(p?.kategori),
                    harga: parseHarga(p?.harga),
                    id: ensureProdukId(p)
                }))
                .filter(p => p.nama.length > 0);

            // Dedup ID agar tombol pilih produk tidak salah (kalau ada ID kosong/duplikat dari Sheets)
            const map = new Map();
            for (const p of clean) {
                // keep first occurrence
                if (!map.has(p.id)) map.set(p.id, p);
            }
            return Array.from(map.values());
        }

        // Migrasi: pastikan semua produk punya kategori + id valid (untuk data lama / sheet yg diedit manual)
        produk = sanitizeProdukList(produk);

        // ========= KONFIGURASI BACKEND (Google Apps Script Web App URL) =========
        // Tempel URL Web App Apps Script Anda di bawah ini.
        // Contoh: const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/XXXX/exec';
        // Jika dikosongkan, fitur Sync ke Google Sheets tidak aktif.
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxzzkCZs1RPGH7UuC1LY5-db-SDcnUVp5QflSpYfUSGZPWygweDsLUGPIOWGgqtypn4/exec';
        let sheetsUrl = (GOOGLE_APPS_SCRIPT_URL || '').trim();

        // Retensi histori pelunasan: transaksi metode "lunas" akan hilang dari histori lokal setelah 5 hari
        const LUNAS_RETENTION_DAYS = 5;
        const MS_PER_DAY = 24 * 60 * 60 * 1000;

        function safeDate(value) {
            const d = new Date(value);
            return Number.isNaN(d.getTime()) ? null : d;
        }

        function pruneTransaksiLunas() {
            const cutoff = Date.now() - (LUNAS_RETENTION_DAYS * MS_PER_DAY);
            const before = (transaksi || []).length;
            transaksi = (transaksi || []).filter(t => {
                const metode = String(t?.metode || '');
                if (metode !== 'lunas') return true;
                const d = safeDate(t?.tanggal);
                if (!d) return true; // kalau tanggal tidak valid, jangan dihapus
                return d.getTime() >= cutoff;
            });
            if ((transaksi || []).length !== before) {
                saveData();
            }
        }

        // Auto sync 3 detik setelah aplikasi dibuka
        // Catatan: tidak ada prompt URL. Sync hanya aktif jika GOOGLE_APPS_SCRIPT_URL diisi.
        let autoSyncTimer = null;
        function scheduleAutoSync() {
            if (autoSyncTimer) clearTimeout(autoSyncTimer);
            autoSyncTimer = setTimeout(() => {
                if (sheetsUrl) syncFromSheets();
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Aplikasi ini hanya untuk HUTANG & PELUNASAN (hapus transaksi tunai lama jika ada)
            transaksi = (transaksi || []).filter(t => String(t.metode || '') !== 'tunai');
            pruneTransaksiLunas();
            saveData();

            renderDashboard();
            renderProdukGrid();
            renderProdukList();
            renderHutangList();

            // Otomatis sync setelah 3 detik
            scheduleAutoSync();

            // PWA (Install di Android)
            setupPWA();
            registerServiceWorker();
        });

        // Tab Navigation
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-gray-600');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            const btn = document.getElementById(`tab-${tab}`);
            btn.classList.add('tab-active');
            btn.classList.remove('text-gray-600');
        }

        // Format Currency
        function formatRupiah(num) {
            const n = Number(num) || 0;
            return 'Rp ' + n.toLocaleString('id-ID');
        }

        // Toast
        let toastTimer = null;
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('bg-green-500', 'bg-red-500');
            toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');

            toast.classList.remove('toast-hidden');
            toast.classList.add('toast-shown');

            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.classList.remove('toast-shown');
                toast.classList.add('toast-hidden');
            }, 2200);
        }

        // Dashboard
        function renderDashboard() {
            pruneTransaksiLunas();

            const today = new Date().toDateString();
            const todayTrans = transaksi.filter(t => new Date(t.tanggal).toDateString() === today && String(t.metode || '') !== 'tunai');
            const totalPelunasan = todayTrans.reduce((sum, t) => sum + ((t.metode === 'bayar' || t.metode === 'lunas') ? Number(t.total) : 0), 0);
            const totalHutang = hutang.reduce((sum, h) => {
                const sisa = (Number(h.total) - Number(h.dibayar));
                return sum + (sisa > 0 ? sisa : 0);
            }, 0);

            document.getElementById('total-hari-ini').textContent = formatRupiah(totalPelunasan);
            document.getElementById('total-hutang').textContent = formatRupiah(totalHutang);
            document.getElementById('jumlah-transaksi').textContent = todayTrans.length;

            const container = document.getElementById('transaksi-terakhir');
            const recent = transaksi.filter(t => String(t.metode || '') !== 'tunai').slice(-5).reverse();
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada transaksi</p>';
                return;
            }

            container.innerHTML = recent.map(t => {
                const metode = String(t.metode || 'tunai');
                const isTunai = metode === 'tunai';
                const isLunas = metode === 'lunas';
                const isBayar = metode === 'bayar' || isLunas;

                const colorText = isTunai ? 'text-green-600' : (isBayar ? 'text-emerald-600' : 'text-orange-600');
                const badge = isTunai ? 'bg-green-100 text-green-700' : (isBayar ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-700');
                const label = isTunai ? 'tunai' : (isLunas ? 'lunas' : (isBayar ? 'bayar' : 'hutang'));

                const pelanggan = (t.pelanggan || '').trim();
                const showNama = !isTunai && pelanggan && pelanggan !== '-';
                const namaHtml = showNama ? ('<p class="text-xs text-gray-700 mt-1">Nama: <b>' + pelanggan + '</b></p>') : '';

                return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                        <div class="min-w-0">
                            <p class="font-semibold text-sm truncate">${t.items}</p>
                            <p class="text-xs text-gray-500">${new Date(t.tanggal).toLocaleString('id-ID')}</p>
                            ${namaHtml}
                        </div>
                        <div class="text-right pl-3 shrink-0">
                            <p class="font-bold ${colorText}">${formatRupiah(t.total)}</p>
                            <span class="text-[10px] px-2 py-1 rounded-lg ${badge}">${label}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Produk Grid (Kasir) - dipisah per kategori
        function renderProdukGrid(list = null) {
            const container = document.getElementById('produk-grid');
            if (!container) return;

            const isFiltered = Array.isArray(list);
            const data = sanitizeProdukList(isFiltered ? list : (produk || []));

            if (data.length === 0) {
                container.innerHTML = isFiltered
                    ? '<p class="text-gray-500 text-center py-8">Produk tidak ditemukan</p>'
                    : '<p class="text-gray-500 text-center py-8">Tambah produk terlebih dahulu</p>';
                return;
            }

            const cardHtml = (p) => {
                const kat = String(p.kategori || 'Minuman');
                const icon = (kat === 'Rokok') ? 'ðŸš¬' : 'ðŸ¥¤';
                const badge = (kat === 'Rokok') ? 'bg-slate-900/10 text-slate-800' : 'bg-sky-500/10 text-sky-700';
                return `
                    <button onclick="tambahKeKeranjang('${p.id}')" class="bg-gray-50 active:bg-blue-50 border-2 border-transparent active:border-blue-300 p-4 rounded-2xl transition text-center">
                        <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto text-2xl">${icon}</div>
                        <p class="font-semibold text-sm leading-tight mt-2">${p.nama}</p>
                        <div class="mt-1 flex items-center justify-center">
                            <span class="text-[10px] px-2 py-1 rounded-lg ${badge}">${kat}</span>
                        </div>
                        <p class="text-blue-600 font-bold text-sm mt-2">${formatRupiah(p.harga)}</p>
                    </button>
                `;
            };

            const categories = [
                { key: 'Minuman', title: 'Minuman', icon: 'ðŸ¥¤', pill: 'bg-sky-500/10 text-sky-700' },
                { key: 'Rokok', title: 'Rokok', icon: 'ðŸš¬', pill: 'bg-slate-900/10 text-slate-800' }
            ];

            let html = '';
            for (const c of categories) {
                const items = data.filter(p => String(p.kategori || 'Minuman') === c.key);
                html += `
                    <div>
                        <div class="flex items-center justify-between px-1 mb-2">
                            <h4 class="font-bold text-sm text-gray-800 flex items-center gap-2">
                                <span class="text-base">${c.icon}</span>
                                <span>${c.title}</span>
                            </h4>
                            <span class="text-[10px] px-2 py-1 rounded-lg ${c.pill}">${items.length} item</span>
                        </div>
                        ${items.length === 0
                            ? '<p class="text-xs text-gray-500 px-1 py-3">Tidak ada produk di kategori ini</p>'
                            : `<div class="grid grid-cols-2 gap-3">${items.map(cardHtml).join('')}</div>`
                        }
                    </div>
                `;
            }

            // Jika hasil search ada tapi kategori kosong semua, tampilkan pesan
            const totalShown = categories.reduce((n, c) => n + data.filter(p => String(p.kategori || 'Minuman') === c.key).length, 0);
            if (isFiltered && totalShown === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Produk tidak ditemukan</p>';
                return;
            }

            container.innerHTML = html;
        }

        function filterProduk() {
            const search = (document.getElementById('search-produk')?.value || '').toLowerCase();
            const filtered = (produk || []).filter(p => (p.nama || '').toLowerCase().includes(search));
            renderProdukGrid(filtered);
        }

        function resetFilterProduk() {
            const s = document.getElementById('search-produk');
            if (s) s.value = '';
            renderProdukGrid();
        }

        // Keranjang
        function tambahKeKeranjang(id) {
            const item = (produk || []).find(p => String(p.id) === String(id));
            if (!item) {
                showToast('Produk tidak ditemukan (sync/ID error)', 'error');
                return;
            }
            const exist = keranjang.find(k => String(k.id) === String(id));
            if (exist) {
                exist.qty++;
            } else {
                keranjang.push({ ...item, qty: 1 });
            }
            renderKeranjang();
        }

        function ubahQty(id, delta) {
            const item = keranjang.find(k => k.id === id);
            if (!item) return;
            item.qty += delta;
            if (item.qty <= 0) {
                keranjang = keranjang.filter(k => k.id !== id);
            }
            renderKeranjang();
        }

        function renderKeranjang() {
            const container = document.getElementById('keranjang');
            if (!container) return;
            if (keranjang.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">Keranjang kosong</p>';
                document.getElementById('total-keranjang').textContent = 'Rp 0';
                return;
            }
            const total = keranjang.reduce((sum, k) => sum + (Number(k.harga) * Number(k.qty)), 0);
            container.innerHTML = keranjang.map(k => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-2xl">
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-sm truncate">${k.nama}</p>
                        <p class="text-xs text-gray-500">${formatRupiah(k.harga)}</p>
                    </div>
                    <div class="flex items-center gap-2 pl-3">
                        <button onclick="ubahQty('${k.id}', -1)" class="w-9 h-9 bg-gray-200 active:bg-gray-300 rounded-xl text-lg font-bold">-</button>
                        <span class="w-8 text-center font-semibold">${k.qty}</span>
                        <button onclick="ubahQty('${k.id}', 1)" class="w-9 h-9 bg-gray-200 active:bg-gray-300 rounded-xl text-lg font-bold">+</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('total-keranjang').textContent = formatRupiah(total);
        }

        function kosongkanKeranjang() {
            keranjang = [];
            renderKeranjang();
        }

        // Transaksi (HUTANG saja)
        function prosesTransaksi() {
            if (keranjang.length === 0) {
                showToast('Keranjang kosong!', 'error');
                return;
            }
            const total = keranjang.reduce((sum, k) => sum + (Number(k.harga) * Number(k.qty)), 0);
            document.getElementById('hutang-total').value = formatRupiah(total);
            document.getElementById('modal-hutang').classList.add('active');
            setTimeout(() => document.getElementById('hutang-nama').focus(), 150);
        }

        // Hutang
        function simpanHutang(e) {
            e.preventDefault();
            const total = keranjang.reduce((sum, k) => sum + (Number(k.harga) * Number(k.qty)), 0);
            const nama = document.getElementById('hutang-nama').value.trim();
            const hp = document.getElementById('hutang-hp').value.trim();

            if (!nama) {
                showToast('Nama pelanggan wajib diisi!', 'error');
                return;
            }

            const trans = {
                id: Date.now().toString(),
                tanggal: new Date().toISOString(),
                items: keranjang.map(k => `${k.nama} x${k.qty}`).join(', '),
                total: total,
                metode: 'hutang',
                pelanggan: nama
            };
            transaksi.push(trans);

            // Jika nama sama dan belum lunas: akumulasi
            const existingHutang = hutang.find(h =>
                (h.nama || '').toLowerCase() === nama.toLowerCase() && (Number(h.total) - Number(h.dibayar)) > 0
            );

            if (existingHutang) {
                existingHutang.total = Number(existingHutang.total) + total;
                if (hp && !existingHutang.hp) existingHutang.hp = hp;
                existingHutang.status = 'belum';

                const idx = hutang.indexOf(existingHutang);
                saveData();
                syncTransaksi(trans);
                syncUpdateHutang(existingHutang, idx + 2);
                showToast(`Hutang ${nama} ditambahkan. Total: ${formatRupiah(existingHutang.total)}`);
            } else {
                const h = {
                    id: Date.now().toString(),
                    tanggal: new Date().toISOString(),
                    nama: nama,
                    hp: hp,
                    total: total,
                    dibayar: 0,
                    status: 'belum'
                };
                hutang.push(h);
                saveData();
                syncTransaksi(trans);
                syncHutang(h);
                showToast('Hutang baru tercatat!');
            }

            keranjang = [];
            renderKeranjang();
            renderDashboard();
            renderHutangList();
            closeModalHutang();
            switchTab('hutang');
        }

        function closeModalHutang() {
            document.getElementById('modal-hutang').classList.remove('active');
            document.getElementById('form-hutang').reset();
        }

        function renderHutangList() {
            const container = document.getElementById('hutang-list');
            if (!container) return;
            if (hutang.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada data hutang</p>';
                return;
            }
            container.innerHTML = hutang.map((h, idx) => {
                const total = Number(h.total) || 0;
                const dibayar = Number(h.dibayar) || 0;
                const sisa = total - dibayar;
                const isLunas = sisa <= 0 || h.status === 'lunas';

                return `
                    <div class="p-4 bg-gray-50 rounded-2xl">
                        <div class="flex justify-between gap-3">
                            <div class="min-w-0">
                                <p class="font-bold truncate">${h.nama}</p>
                                <p class="text-xs text-gray-500">${h.hp || '-'} â€¢ ${new Date(h.tanggal).toLocaleDateString('id-ID')}</p>
                                <p class="text-xs text-gray-700 mt-1">Total: <b>${formatRupiah(total)}</b> â€¢ Dibayar: <b>${formatRupiah(dibayar)}</b></p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${isLunas ? 'text-green-600' : 'text-red-600'}">${isLunas ? 'LUNAS' : formatRupiah(sisa)}</p>
                            </div>
                        </div>
                        ${!isLunas ? `
                            <button onclick="openBayarHutang(${idx})" class="mt-3 w-full bg-green-500 active:bg-green-600 text-white py-3 rounded-xl font-semibold">Bayar</button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterHutang() {
            const search = (document.getElementById('search-hutang').value || '').toLowerCase();
            const status = document.getElementById('filter-status').value;

            let filtered = hutang.filter(h => (h.nama || '').toLowerCase().includes(search));

            if (status === 'belum') {
                filtered = filtered.filter(h => (Number(h.total) - Number(h.dibayar)) > 0);
            }
            if (status === 'lunas') {
                filtered = filtered.filter(h => (Number(h.total) - Number(h.dibayar)) <= 0 || h.status === 'lunas');
            }

            const container = document.getElementById('hutang-list');
            if (!container) return;
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Tidak ada data</p>';
                return;
            }

            container.innerHTML = filtered.map(h => {
                const idx = hutang.indexOf(h);
                const total = Number(h.total) || 0;
                const dibayar = Number(h.dibayar) || 0;
                const sisa = total - dibayar;
                const isLunas = sisa <= 0 || h.status === 'lunas';

                return `
                    <div class="p-4 bg-gray-50 rounded-2xl">
                        <div class="flex justify-between gap-3">
                            <div class="min-w-0">
                                <p class="font-bold truncate">${h.nama}</p>
                                <p class="text-xs text-gray-500">${h.hp || '-'} â€¢ ${new Date(h.tanggal).toLocaleDateString('id-ID')}</p>
                                <p class="text-xs text-gray-700 mt-1">Total: <b>${formatRupiah(total)}</b> â€¢ Dibayar: <b>${formatRupiah(dibayar)}</b></p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${isLunas ? 'text-green-600' : 'text-red-600'}">${isLunas ? 'LUNAS' : formatRupiah(sisa)}</p>
                            </div>
                        </div>
                        ${!isLunas ? `
                            <button onclick="openBayarHutang(${idx})" class="mt-3 w-full bg-green-500 active:bg-green-600 text-white py-3 rounded-xl font-semibold">Bayar</button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function openBayarHutang(idx) {
            const h = hutang[idx];
            const sisa = (Number(h.total) || 0) - (Number(h.dibayar) || 0);
            document.getElementById('bayar-id').value = idx;
            document.getElementById('bayar-sisa').value = formatRupiah(sisa);
            const bayarInput = document.getElementById('bayar-jumlah');
            bayarInput.max = Math.max(1, sisa);
            bayarInput.value = '';
            document.getElementById('modal-bayar').classList.add('active');
            setTimeout(() => bayarInput.focus(), 150);
        }

        function closeModalBayar() {
            document.getElementById('modal-bayar').classList.remove('active');
        }

        function bayarHutang(e) {
            e.preventDefault();
            const idx = parseInt(document.getElementById('bayar-id').value);
            const jumlah = Number(document.getElementById('bayar-jumlah').value);

            if (!Number.isFinite(jumlah) || jumlah <= 0) {
                showToast('Jumlah bayar tidak valid!', 'error');
                return;
            }

            const h = hutang[idx];
            if (!h) {
                showToast('Data hutang tidak ditemukan!', 'error');
                return;
            }

            const nama = (h.nama || '-').trim() || '-';
            const totalBefore = Number(h.total) || 0;
            const dibayarBefore = Number(h.dibayar) || 0;
            const sisaBefore = Math.max(0, totalBefore - dibayarBefore);
            const bayar = Math.min(jumlah, sisaBefore);

            // Update hutang
            h.dibayar = dibayarBefore + bayar;
            const lunas = Number(h.dibayar) >= totalBefore;

            // Catat transaksi pembayaran hutang agar muncul di "Aktivitas Terakhir"
            const payTrans = {
                id: Date.now().toString(),
                tanggal: new Date().toISOString(),
                items: lunas ? 'Pelunasan Hutang' : 'Bayar Hutang',
                total: bayar,
                metode: lunas ? 'lunas' : 'bayar',
                pelanggan: nama
            };
            transaksi.push(payTrans);
            syncTransaksi(payTrans);

            if (lunas) {
                syncDeleteHutang(idx + 2);
                hutang.splice(idx, 1);
                showToast(`Hutang ${nama} LUNAS & dihapus!`);
            } else {
                h.status = 'belum';
                syncUpdateHutang(h, idx + 2);
                showToast('Pembayaran berhasil!');
            }

            saveData();
            renderHutangList();
            renderDashboard();
            closeModalBayar();
        }

        // Produk Management
        function renderProdukList() {
            const container = document.getElementById('produk-list');
            if (!container) return;
            if (produk.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada produk</p>';
                return;
            }
            container.innerHTML = produk.map((p, idx) => {
                const kat = String(p.kategori || 'Minuman');
                const badge = (kat === 'Rokok') ? 'bg-slate-900/10 text-slate-800' : 'bg-sky-500/10 text-sky-700';
                return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-2xl">
                        <div class="min-w-0">
                            <p class="font-semibold truncate">${p.nama}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] px-2 py-1 rounded-lg ${badge}">${kat}</span>
                                <p class="text-xs text-gray-500">${formatRupiah(p.harga)}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="editProduk(${idx})" class="text-blue-600" aria-label="Edit">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            </button>
                            <button onclick="hapusProduk(${idx})" class="text-red-600" aria-label="Hapus">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openModalProduk() {
            document.getElementById('modal-produk-title').textContent = 'Tambah Produk';
            document.getElementById('form-produk').reset();
            document.getElementById('produk-id').value = '';
            document.getElementById('produk-kategori').value = 'Minuman';
            document.getElementById('modal-produk').classList.add('active');
            setTimeout(() => document.getElementById('produk-nama').focus(), 150);
        }

        function closeModalProduk() {
            document.getElementById('modal-produk').classList.remove('active');
        }

        function editProduk(idx) {
            const p = produk[idx];
            document.getElementById('modal-produk-title').textContent = 'Edit Produk';
            document.getElementById('produk-id').value = idx;
            document.getElementById('produk-nama').value = p.nama;
            document.getElementById('produk-kategori').value = String(p.kategori || 'Minuman');
            document.getElementById('produk-harga').value = p.harga;
            document.getElementById('modal-produk').classList.add('active');
            setTimeout(() => document.getElementById('produk-nama').focus(), 150);
        }

        function simpanProduk(e) {
            e.preventDefault();
            const idx = document.getElementById('produk-id').value;
            const data = {
                id: idx !== '' ? produk[idx].id : Date.now().toString(),
                nama: document.getElementById('produk-nama').value.trim(),
                kategori: normalizeKategori(document.getElementById('produk-kategori').value || 'Minuman'),
                harga: parseHarga(document.getElementById('produk-harga').value)
            };

            if (!data.nama || !Number.isFinite(data.harga) || data.harga < 0) {
                showToast('Nama/harga tidak valid!', 'error');
                return;
            }

            if (!['Minuman', 'Rokok'].includes(data.kategori)) {
                data.kategori = 'Minuman';
            }

            if (idx !== '') {
                produk[idx] = data;
                syncProduk(data);
            } else {
                produk.push(data);
                syncProduk(data);
            }

            // pastikan list bersih (id unik)
            produk = sanitizeProdukList(produk);

            saveData();
            renderProdukList();
            renderProdukGrid();
            closeModalProduk();
            showToast('Produk tersimpan!');
        }

        function hapusProduk(idx) {
            if (confirm('Hapus produk ini?')) {
                const id = produk?.[idx]?.id;
                produk.splice(idx, 1);
                saveData();
                if (id) syncDeleteProdukById(id);
                renderProdukList();
                renderProdukGrid();
                showToast('Produk dihapus!');
            }
        }

        // Sync manual
        function manualSync() {
            if (!sheetsUrl) {
                showToast('Backend belum diset. Isi GOOGLE_APPS_SCRIPT_URL di index.html', 'error');
                return;
            }
            syncFromSheets();
        }

        // PWA (Install di Android)
        let deferredInstallPrompt = null;

        function setupPWA() {
            // Manifest PWA (dibuat dinamis agar tetap 1 file)
            try {
                const iconPng = 'mas-abel.png';

                const manifest = {
                    name: 'Warung Mas Abel - Hutang & Pelunasan',
                    short_name: 'Mas Abel',
                    start_url: './',
                    scope: './',
                    display: 'standalone',
                    background_color: '#0b1220',
                    theme_color: '#1d4ed8',
                    icons: [
                        { src: iconPng, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
                        { src: iconPng, sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
                    ]
                };

                const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
                const manifestUrl = URL.createObjectURL(manifestBlob);
                const link = document.getElementById('manifest-link');
                if (link) link.setAttribute('href', manifestUrl);
            } catch (e) {
                console.warn('Manifest error:', e);
            }

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredInstallPrompt = e;
                const btn = document.getElementById('btn-install');
                if (btn) btn.classList.remove('hidden');
            });

            window.addEventListener('appinstalled', () => {
                deferredInstallPrompt = null;
                const btn = document.getElementById('btn-install');
                if (btn) btn.classList.add('hidden');
                showToast('Aplikasi terinstal!');
            });
        }

        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) return;
            try {
                const swCode = `const CACHE='wma-cache-v3';
self.addEventListener('install', (e)=>{e.waitUntil((async()=>{const c=await caches.open(CACHE);try{await c.addAll(['./','./mas-abel.png']);}catch(_){ } self.skipWaiting();})());});
self.addEventListener('activate', (e)=>{e.waitUntil((async()=>{await self.clients.claim();})();)});
self.addEventListener('fetch', (e)=>{ if(e.request.method!=='GET') return; e.respondWith((async()=>{const cached=await caches.match(e.request); if(cached) return cached; try{const res=await fetch(e.request); const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request, copy)).catch(()=>{}); return res;}catch(err){ return cached || Response.error(); }})());});`;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                const swUrl = URL.createObjectURL(blob);
                await navigator.serviceWorker.register(swUrl, { scope: './' });
            } catch (e) {
                console.warn('SW register gagal:', e);
            }
        }

        async function triggerInstall() {
            if (!deferredInstallPrompt) {
                showToast('Install belum tersedia di perangkat ini', 'error');
                return;
            }
            deferredInstallPrompt.prompt();
            try {
                const choice = await deferredInstallPrompt.userChoice;
                deferredInstallPrompt = null;
                const btn = document.getElementById('btn-install');
                if (btn) btn.classList.add('hidden');
                if (choice && choice.outcome === 'accepted') {
                    showToast('Memulai instal...');
                } else {
                    showToast('Install dibatalkan', 'error');
                }
            } catch (e) {
                console.warn(e);
            }
        }

        // Local Storage
        function saveData() {
            localStorage.setItem('produk', JSON.stringify(produk));
            localStorage.setItem('transaksi', JSON.stringify(transaksi));
            localStorage.setItem('hutang', JSON.stringify(hutang));
        }

        // Google Sheets Sync
        async function syncProduk(data) {
            if (!sheetsUrl) return;
            try {
                // Simpan berdasarkan ID (backend akan upsert)
                await fetch(`${sheetsUrl}?action=upsertProdukById&data=${encodeURIComponent(JSON.stringify(data))}`);
            } catch (err) { console.error(err); }
        }

        async function syncDeleteProdukById(id) {
            if (!sheetsUrl) return;
            try {
                await fetch(`${sheetsUrl}?action=deleteProdukById&id=${encodeURIComponent(String(id || ''))}`);
            } catch (err) { console.error(err); }
        }

        async function syncTransaksi(data) {
            if (!sheetsUrl) return;
            try {
                await fetch(`${sheetsUrl}?action=saveTransaksi&data=${encodeURIComponent(JSON.stringify(data))}`);
            } catch (err) { console.error(err); }
        }

        async function syncHutang(data) {
            if (!sheetsUrl) return;
            try {
                await fetch(`${sheetsUrl}?action=saveHutang&data=${encodeURIComponent(JSON.stringify(data))}`);
            } catch (err) { console.error(err); }
        }

        async function syncUpdateHutang(data, row) {
            if (!sheetsUrl) return;
            try {
                const payload = { ...data, row };
                await fetch(`${sheetsUrl}?action=saveHutang&data=${encodeURIComponent(JSON.stringify(payload))}`);
            } catch (err) { console.error(err); }
        }

        async function syncDeleteHutang(row) {
            if (!sheetsUrl) return;
            try {
                await fetch(`${sheetsUrl}?action=deleteHutang&row=${row}`);
            } catch (err) { console.error(err); }
        }

        function normalizeProdukRow(row) {
            // Dukungan beberapa format baris dari Google Sheets:
            // 1) Format benar (baru): [id, nama, kategori, harga]
            // 2) Format terbalik (umum terjadi kalau header lama): [id, nama, harga, kategori]
            // 3) Format lama: [id, nama, harga]
            // 4) Harga ditulis string: "Rp 10.000" / "10.000"
            const id = String(row?.[0] ?? '').trim();
            const nama = String(row?.[1] ?? '').trim();

            const c2 = row?.[2]; // bisa kategori atau harga
            const c3 = row?.[3]; // bisa harga atau kategori

            const c2IsKat = isKategoriLike(c2);
            const c3IsKat = isKategoriLike(c3);

            const h2 = parseHarga(c2);
            const h3 = parseHarga(c3);

            // Format benar: [id, nama, kategori, harga]
            if (c2IsKat) {
                return {
                    id,
                    nama,
                    kategori: normalizeKategori(c2),
                    harga: h3
                };
            }

            // Format terbalik: [id, nama, harga, kategori]
            if (c3IsKat && !c2IsKat) {
                return {
                    id,
                    nama,
                    kategori: normalizeKategori(c3),
                    harga: h2
                };
            }

            // Jika kolom 4 ada dan terlihat seperti angka, kemungkinan kategori kosong/typo (tetap ambil harga kol4)
            if (String(c3 ?? '').trim() !== '' && h3 > 0) {
                return {
                    id,
                    nama,
                    kategori: 'Minuman',
                    harga: h3
                };
            }

            // Format lama: [id, nama, harga]
            if (String(c2 ?? '').trim() !== '' && h2 > 0) {
                return {
                    id,
                    nama,
                    kategori: 'Minuman',
                    harga: h2
                };
            }

            // Fallback aman
            return {
                id,
                nama,
                kategori: 'Minuman',
                harga: h3 || h2 || 0
            };
        }

        // Sync dari Google Sheets (dioptimalkan agar cepat)
        const SYNC_LIMIT_TRANSAKSI = 1200; // ambil transaksi terbaru saja
        const SYNC_LIMIT_HUTANG = 1500;
        const SYNC_LIMIT_PRODUK = 2000;
        const SYNC_TIMEOUT_MS = 8000;

        function fetchWithTimeout(url, ms = SYNC_TIMEOUT_MS) {
            const ctrl = new AbortController();
            const t = setTimeout(() => ctrl.abort(), ms);
            return fetch(url, { signal: ctrl.signal })
                .finally(() => clearTimeout(t));
        }

        async function syncFromSheets() {
            if (!sheetsUrl) return;
            try {
                // Ambil semua data secara paralel (lebih cepat)
                const [resProduk, resTrans, resHutang] = await Promise.all([
                    fetchWithTimeout(`${sheetsUrl}?action=getProduk&limit=${SYNC_LIMIT_PRODUK}`),
                    fetchWithTimeout(`${sheetsUrl}?action=getTransaksi&limit=${SYNC_LIMIT_TRANSAKSI}`),
                    fetchWithTimeout(`${sheetsUrl}?action=getHutang&limit=${SYNC_LIMIT_HUTANG}`)
                ]);

                const [dataProduk, dataTrans, dataHutang] = await Promise.all([
                    resProduk.json(),
                    resTrans.json(),
                    resHutang.json()
                ]);

                // Produk
                if (dataProduk.success && Array.isArray(dataProduk.data)) {
                    // Skip baris kosong (kadang ada baris kosong di bawah)
                    // Lalu normalisasi urutan kolom & kategori agar tidak reset setelah sync.
                    produk = sanitizeProdukList(
                        dataProduk.data
                            .filter(r => r && (String(r[0] ?? '').trim() || String(r[1] ?? '').trim()))
                            .map(row => normalizeProdukRow(row))
                    );
                }

                // Transaksi
                if (dataTrans.success && Array.isArray(dataTrans.data)) {
                    transaksi = dataTrans.data
                        .filter(r => r && r.length >= 6)
                        .map(row => ({
                            id: String(row[0]),
                            tanggal: String(row[1]),
                            items: String(row[2]),
                            total: Number(row[3]) || 0,
                            metode: String(row[4]),
                            pelanggan: String(row[5])
                        }))
                        .filter(t => String(t.metode || '') !== 'tunai');
                }

                // Hutang
                if (dataHutang.success && Array.isArray(dataHutang.data)) {
                    hutang = dataHutang.data
                        .filter(r => r && r.length >= 7)
                        .map(row => ({
                            id: String(row[0]),
                            tanggal: String(row[1]),
                            nama: String(row[2]),
                            hp: String(row[3] || ''),
                            total: Number(row[4]) || 0,
                            dibayar: Number(row[5]) || 0,
                            status: String(row[6] || 'belum')
                        }));
                }

                // Terapkan retensi setelah sync
                pruneTransaksiLunas();

                saveData();
                renderDashboard();
                renderProdukGrid();
                renderProdukList();
                renderHutangList();
                showToast('Sync selesai');
            } catch (err) {
                console.error('Sync error:', err);
                const msg = (err && err.name === 'AbortError') ? 'Sync timeout (koneksi lambat)' : (err.message || String(err));
                showToast('Sync gagal: ' + msg, 'error');
            }
        }

        // UX: klik overlay untuk tutup modal
        document.addEventListener('click', (e) => {
            const modals = ['modal-produk', 'modal-hutang', 'modal-bayar'];
            for (const id of modals) {
                const el = document.getElementById(id);
                if (!el || !el.classList.contains('active')) continue;
                if (e.target === el) {
                    if (id === 'modal-produk') closeModalProduk();
                    if (id === 'modal-hutang') closeModalHutang();
                    if (id === 'modal-bayar') closeModalBayar();
                }
            }
        });
    </script>
</body>
</html>
